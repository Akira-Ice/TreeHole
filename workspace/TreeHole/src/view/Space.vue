<script setup>
import api from "../api";
import request from "../api/request";
import { computed, nextTick, onMounted, reactive, ref, toRaw } from "vue-demi";
import { local, defaultState, recordHandle } from "../util";
import TreeCard from "../components/TreeCard.vue";
import { Edit, Delete } from "@element-plus/icons-vue";
import { useRouter } from "vue-router";
import { ElMessage } from "element-plus";
import { Plus } from "@element-plus/icons-vue";

const router = useRouter();

// [state]
const loginUser = local.getItem("user");
const treeID = history.state.treeID || "";
const state = reactive({
  user: history.state.spaceUser || loginUser,
  record: defaultState.record,
  loginRecord: defaultState.record,
  isFollow: false,
  // ÂºπÂá∫Â±Ç
  dialog_user: false,
  dialog_tree: false,
  from_user: loginUser,
  from_tree: {},
});

// [methods]
// Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
const updateUserInfo = async () => {
  // È™åËØÅÂú∞Âå∫Ê†ºÂºè
  if (state.from_user.location.split("-").length != 2) {
    ElMessage.error("Âú∞Âå∫Ê†ºÂºèÊúâËØØÔºåÊ≠£Á°ÆÊ†ºÂºèÔºöxx(ÁúÅ)-xx(Â∏Ç) Â¶ÇÔºöÂÆâÂæΩ-ÂÆâÂ∫Ü");
    return;
  }
  await request.post(api.user.modifyById, state.from_user);
  // Êõ¥Êñ∞ÁºìÂ≠ò
  ElMessage.success("Áî®Êà∑‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäü");
  local.setItem("user", state.from_user);
  state.dialog_user = false;
};

/**
 * Â§¥ÂÉè‰∏ä‰º†ÊàêÂäüÂõûË∞É
 * @param {object} response
 * @param {file} uploadFile
 */
const handleAvatarSuccess = async (response, uploadFile) => {
  state.user.avator = response.message;
  await request.post(api.user.modifyById, toRaw(state.user));
  local.setItem("user", state.user);
  ElMessage.success("Â§¥ÂÉè‰∏ä‰º†ÊàêÂäü");
};

/**
 * Â§¥ÂÉè‰∏ä‰º†ÊàêÂäü‰πãÂâçÂõûË∞É
 * @param {file} rawFile
 */
const beforeAvatarUpload = (rawFile) => {
  if (rawFile.type !== "image/jpeg") {
    // ÂõæÁâáËµÑÊ∫êÊ†ºÂºèÈ™åËØÅ
    ElMessage.error("Avatar picture must be JPG format!");
    return false;
  } else if (rawFile.size / 1024 / 1024 > 2) {
    // ÂõæÁâáÂ§ßÂ∞èÈôêÂà∂
    ElMessage.error("Avatar picture size can not exceed 2MB!");
    return false;
  }
  return true;
};

/**
 * Êî∂Ëóè
 * @param {string} treeID
 */
const collectHandle = (tree) => {
  recordHandle.collect(state.record, loginUser, tree);
};

// Ë∑≥ËΩ¨ËÆ∞ÂΩï
const toRecord = () => {
  if (isCurrentUser.value) router.push({ name: "Record" });
};

// Ë∑≥ËΩ¨ËÅäÂ§©
const toSocket = async () => {
  const userID1 = loginUser._id;
  const userID2 = state.user._id;
  const treeID = "";
  await request.post(api.socket.addSocket, { userID1, userID2, treeID });
  router.push({ name: "Socket", state: { userID: userID2 } });
};

const handleCommand = (command) => {
  console.log(`output->command`, command);
};

// ÂÖ≥Ê≥®/ÂèñÊ∂àÂÖ≥Ê≥®
const followHandle = async () => {
  const { fans, fansList } = state.record;

  const userID1 = loginUser._id;
  const userID2 = state.user._id;
  await request.post(api.record.modifyRecordUser, { userID1, userID2 });

  // Êõ¥Êñ∞ÁºìÂ≠ò
  state.isFollow = !state.isFollow;
  const index = fans.indexOf(loginUser._id);
  if (index == -1) {
    fans.push(loginUser._id);
    fansList.push(loginUser);
    ElMessage.success("ÂÖ≥Ê≥®ÊàêÂäü");
  } else {
    fans.splice(index, 1);
    fansList.splice(index, 1);
    ElMessage.success("ÂèñÊ∂àÂÖ≥Ê≥®ÊàêÂäü");
  }
};

// [computed]
const record = computed(() => state.record);

// ÊòØÂê¶ÊòØÂΩìÂâçÁî®Êà∑
const isCurrentUser = computed(() => {
  return state.user._id == loginUser._id;
});

onMounted(async () => {
  if (loginUser._id != state.user._id) state.loginRecord = await request.post(api.record.getRecordByUserID, { userID: loginUser._id });
  state.record = await request.post(api.record.getRecordByUserID, { userID: state.user._id });
  if (!isCurrentUser.value) state.isFollow = state.record.fans.indexOf(loginUser._id) != -1;

  // ÊªöÂä®Êù°Ë°å‰∏∫
  if (treeID != "") {
    nextTick(() => {
      const mainRef = document.getElementsByClassName("el-card");
      let targetTree = 0;
      state.record.treeList.forEach((item, index) => {
        if (item._id == treeID) targetTree = index;
      });
      mainRef[targetTree].scrollIntoView({ block: "center" });
    });
  }
});
</script>

<template>
  <div class="container scroll">
    <!-- Áî®Êà∑‰ø°ÊÅØÂØπËØùÊ°Ü -->
    <el-dialog title="Áî®Êà∑‰ø°ÊÅØ" v-model="state.dialog_user" width="45%" align-center>
      <el-form :model="state.from_user" label-width="auto">
        <el-form-item label="Áî®Êà∑Âêç">
          <el-input v-model="state.from_user.account" autocomplete="off" disabled />
        </el-form-item>
        <el-form-item label="ÂßìÂêç">
          <el-input v-model="state.from_user.name" />
        </el-form-item>
        <el-form-item label="Âú∞Âå∫">
          <el-input v-model="state.from_user.location" placeholder="xx(ÁúÅ)-xx(Â∏Ç) Â¶ÇÔºöÂÆâÂæΩ-ÂÆâÂ∫Ü" />
        </el-form-item>
        <el-form-item label="ÊÄßÂà´">
          <el-radio-group v-model="state.from_user.sex">
            <el-radio :label="'0'">ü§¶‚Äç‚ôÄÔ∏è</el-radio>
            <el-radio :label="'1'">ü§¶‚Äç‚ôÇÔ∏è</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="state.dialog_user = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="updateUserInfo">‰øùÂ≠ò</el-button>
        </span>
      </template>
    </el-dialog>
    <!-- ‰∏™‰∫∫Á©∫Èó¥-È°∂ÈÉ® -->
    <div class="container__top">
      <!-- Â∞ÅÈù¢ -->
      <div class="top__cover"></div>
      <!-- Áî®Êà∑‰ø°ÊÅØ -->
      <div class="top__user">
        <div class="user_info">
          <span class="user__name">{{ state.user.name }}</span>
          <div class="btnOption">
            <el-button class="editUserInfo" v-if="isCurrentUser" @click="state.dialog_user = true">ÁºñËæë‰∏™‰∫∫ËµÑÊñô</el-button>
            <div class="unFollow btn" @click="followHandle" v-if="!isCurrentUser">{{ state.isFollow ? "ÂèñÊ∂àÂÖ≥Ê≥®" : "ÂÖ≥Ê≥®" }}</div>
            <div class="message btn" @click="toSocket" v-if="!isCurrentUser">Âèë‰ø°ÊÅØ</div>
          </div>
        </div>
        <div class="user__record" @click="toRecord">
          <div class="record__item">
            <span class="item__count">{{ record.following?.length || "-" }}</span>
            <span class="item__type">ÂÖ≥Ê≥®</span>
          </div>
          <div class="record__item">
            <span class="item__count">{{ record.fans?.length || "-" }}</span>
            <span class="item__type">Á≤â‰∏ù</span>
          </div>
        </div>
      </div>
      <el-upload class="avatar-uploader" action="/api/uploadCenter/upload" :show-file-list="false" :on-success="handleAvatarSuccess" :before-upload="beforeAvatarUpload" :disabled="!isCurrentUser">
        <img :src="state.user.avator || 'https://bpic.51yuansu.com/pic3/cover/01/69/80/595f67c042c1b_610.jpg?x-oss-process=image/resize,w_260/sharpen,100'" class="avator" />
      </el-upload>
    </div>
    <!-- ‰∏ª‰Ωì-Ê†ëÂàóË°® -->
    <div class="container__main">
      <div class="release" v-if="isCurrentUser">ÂèëÂ∏Éüôå</div>
      <el-empty description="description" v-if="record.treeList.length == 0" />
      <TreeCard v-for="(item, index) in record.treeList" :key="item._id" :tree="item" :record="state.loginRecord" :collectHandle="collectHandle">
        <el-dropdown trigger="click" @command="handleCommand" v-if="isCurrentUser">
          <span class="el-dropdown-link"><i class="iconfont icon-gengduo"></i></span>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item :icon="Edit" command="0">ÁºñËæë</el-dropdown-item>
              <el-dropdown-item :icon="Delete" command="1">Âà†Èô§</el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </TreeCard>
    </div>
  </div>
</template>

<style lang="less" scoped>
//color
@defaultColor: rgb(155, 161, 166);
@activeColor: rgb(94, 161, 97);

// calc sidebar topbar
@sidebar_width: 65px;
@topbar_height: 75px;

.flex__column {
  display: flex;
  flex-direction: column;
}
.flex__row {
  display: flex;
  flex-direction: row;
}

.btn {
  font-size: 14px;
  padding: 10px;
  border-radius: 8px;
  transition: all 0.3s;
  cursor: pointer;
}

.container {
  height: calc(100vh - @topbar_height);
  overflow-y: auto;
  position: relative;
  :deep(.el-dialog) {
    border-radius: 10px;
  }

  .container__top {
    .flex__column();
    height: 300px;
    position: relative;
    .top__cover {
      width: 100%;
      height: 70%;
      background: url("../assets/spaceBack.png");
      background-position: bottom;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }
    .top__user {
      .flex__row();
      flex: 1;
      justify-content: space-between;
      align-items: center;
      margin-left: calc(2.5vw + 130px);
      .user_info {
        .flex__column();
        align-items: center;
        gap: 10px;
        .user__name {
          font-size: 20px;
          font-weight: bold;
          padding-top: 15px;
          align-self: flex-start;
        }
        .btnOption {
          gap: 10px;
          .flex__row();
          .editUserInfo {
            bottom: 10px;
          }
          .unFollow {
            color: @activeColor;
            background-color: rgba(94, 161, 97, 0.11);
            &:hover {
              color: white;
              background-color: @activeColor;
            }
          }
          .message {
            color: black;
            background-color: rgba(164, 179, 165, 0.144);
          }
        }
      }
      .user__record {
        .flex__row();
        margin-right: 4.167vw;
        cursor: pointer;
        .record__item {
          .flex__column();
          align-items: center;
          margin: 0 20px;
          .item__count {
            font-size: 20px;
            font-weight: 500;
            padding: 10px;
          }
          .item__type {
            font-size: 13px;
            color: @defaultColor;
          }
        }
      }
    }
    .avator {
      width: 100px;
      border-radius: 100px;
      border: 2px solid white;
      position: absolute;
      bottom: 0.833vw;
      left: 2.5vw;
    }
    .avatar-uploader {
      .el-upload {
        border: 1px dashed var(--el-border-color-darker);
        border-radius: 6px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: var(--el-transition-duration-fast);
      }
      .el-upload:hover {
        border-color: var(--el-color-primary);
      }
      .el-icon.avatar-uploader-icon {
        font-size: 28px;
        color: #8c939d;
        width: 100px;
        height: 100px;
        text-align: center;
      }
    }
  }
  .container__main {
    background-color: rgb(241, 242, 243);
    padding: 10px 265px;
    min-height: calc(100vh - 395px);
    position: relative;
    .el-dropdown-link {
      cursor: pointer;
    }
    .icon-gengduo {
      font-weight: bold;
    }
    .release {
      position: absolute;
      top: 20px;
      right: 40px;
      padding: 12px;
      border-radius: 10px;
      background-color: @activeColor;
      color: white;
      cursor: pointer;

      &:hover {
        transform: scale(1.05);
      }
    }
  }
}
</style>
